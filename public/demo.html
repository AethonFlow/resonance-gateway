<!doctype html><html lang="en"><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Demo – Run = Cycle</title>
<style>
:root{--pad:24px}
body{font:16px/1.5 system-ui;margin:2rem;max-width:980px;color:#111}
label,select,button{font:inherit}.row{display:flex;gap:1rem;align-items:center;margin:.5rem 0;flex-wrap:wrap}
pre{background:#f7f7f7;padding:1rem;border-radius:8px;overflow:auto}.badge{padding:.2rem .5rem;border:1px solid #ddd;border-radius:6px}
.card{border:1px solid #e6e6e6;border-radius:12px;padding:var(--pad);margin-top:1rem}
.small{opacity:.8;font-size:.9rem}
svg{width:100%;height:320px;border:1px dashed #eee;border-radius:12px;background:#fff}
.node{cursor:default}
.tooltip{margin-top:.25rem;padding:.4rem .6rem;border:1px solid #eee;border-radius:8px;background:#fafafa}
.legend{display:flex;gap:.5rem;align-items:center;margin-top:.5rem}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #aaa}
</style>

<h1>Run = Cycle</h1>
<p class="small">Select two houses — the <em>Run</em> reveals resonance. No conducting, just coupling to the CORE.</p>

<div class="row card">
  <label for="a">House A:</label>
  <select id="a">
    <option>NNO</option><option>ONO</option><option>OSO</option><option>SSO</option>
    <option>SSW</option><option>WSW</option><option>WNW</option><option>NNW</option>
  </select>

  <label for="b">House B:</label>
  <select id="b">
    <option>ONO</option><option>OSO</option><option>SSO</option><option>SSW</option>
    <option>WSW</option><option>WNW</option><option>NNW</option><option>NNO</option>
  </select>

  <button id="run">Start run</button>
  <div id="status" class="badge">ready</div>
</div>

<div class="card">
  <svg id="viz" viewBox="0 0 800 320" aria-label="Resonance graph">
    <!-- filled via JS -->
  </svg>
  <div id="tip" class="tooltip" aria-live="polite">—</div>
  <div class="legend">
    <span class="dot" style="background:#999"></span><span class="small">neutral</span>
    <span class="dot" style="background:#31a354"></span><span class="small">neighbor</span>
    <span class="dot" style="background:#d95f0e"></span><span class="small">complement</span>
  </div>
</div>

<div class="card">
  <h2>Result (JSON)</h2>
  <pre id="out">—</pre>
</div>

<p class="small">More about the Target Map: <a href="/about.html">What is the Resonance Gateway?</a></p>

<script>
const svg = document.getElementById('viz');
const tip = document.getElementById('tip');
function colorFor(type){
  if(type==="complement") return "#d95f0e";
  if(type==="neighbor") return "#31a354";
  return "#999";
}
function renderGraph(json){
  svg.innerHTML="";
  const W=800,H=320, cx=W/2, cy=H/2;
  const A={x:160,y:cy}, CORE={x:cx,y:cy}, B={x:W-160,y:cy};
  const abEdge = json.edges.find(e=>e.from!=="CORE" && e.to!=="CORE") || {};
  const type = abEdge.type || "neutral";

  // edges
  const line = (p,q,cls)=> {
    const l=document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1",p.x); l.setAttribute("y1",p.y);
    l.setAttribute("x2",q.x); l.setAttribute("y2",q.y);
    l.setAttribute("stroke", colorFor(cls)); l.setAttribute("stroke-width","3");
    l.setAttribute("stroke-linecap","round");
    svg.appendChild(l); return l;
  };
  line(A,CORE,"neutral"); line(CORE,B,"neutral");
  const pulse = line(A,B,type);
  pulse.setAttribute("stroke-dasharray","6 6");
  let d=0; (function anim(){ d=(d+1)%12; pulse.setAttribute("stroke-dashoffset", d); requestAnimationFrame(anim); })();

  // nodes
  function node(p,label,fill="#fff"){
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("class","node");
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",p.x); c.setAttribute("cy",p.y); c.setAttribute("r","26");
    c.setAttribute("fill",fill); c.setAttribute("stroke","#111"); c.setAttribute("stroke-width","1.5");
    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",p.x); t.setAttribute("y",p.y+5); t.setAttribute("text-anchor","middle");
    t.setAttribute("font-size","14"); t.textContent=label;
    g.appendChild(c); g.appendChild(t); svg.appendChild(g);
  }
  node(A, json.nodes.find(n=>n.role==="source").id);
  node(CORE, "CORE", "#f8f8f8");
  node(B, json.nodes.find(n=>n.role==="target").id);

  tip.textContent = json.commentary;
  document.getElementById('out').textContent = JSON.stringify(json,null,2);
}

async function run(){
  const a=document.getElementById('a').value, b=document.getElementById('b').value;
  const status=document.getElementById('status');
  status.textContent="running…";
  try{
    const res=await fetch(`/.netlify/functions/resonance?houseA=${a}&houseB=${b}`);
    const json=await res.json();
    renderGraph(json);
    status.textContent="done";
  }catch(e){
    tip.textContent="Error: "+e;
    status.textContent="error";
  }
}
document.getElementById('run').addEventListener('click',run);
run(); // initial
</script>

<!-- ===== Cycles MVP — add-on section (non-intrusive) ===== -->
<section class="card" style="margin-top:1.5rem">
  <h2>Cycles MVP (WSW → WNW → Core)</h2>
  <p class="small">Kick off a cycle with soft market signals (WSW), distill them to light metrics (WNW), then synthesize in the Integration Core.</p>

  <div class="row">
    <label>Topic
      <input id="cx-topic" value="Student Weinkontor" />
    </label>
    <label>Phase
      <select id="cx-phase">
        <option>init</option>
        <option>cycle-1</option>
      </select>
    </label>
    <span id="cx-status" class="badge">idle</span>
  </div>

  <div class="row">
    <button id="cx-run-wsw">Run WSW (Market)</button>
    <button id="cx-run-wnw">Run WNW (Analytics)</button>
    <button id="cx-run-core">Synthesize Core</button>
  </div>

  <pre id="cx-out" style="margin-top:1rem;white-space:pre-wrap;background:#f7f7f7;padding:1rem;border-radius:8px;overflow:auto">—</pre>
</section>

<script>
(() => {
  async function post(url, data) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(data || {})
    });
    return r.json();
  }

  const $ = (id) => document.getElementById(id);
  let cycleId = null;

  $("cx-run-wsw").onclick = async () => {
    $("cx-status").textContent = "WSW…";
    const topic = $("cx-topic").value;
    const phase = $("cx-phase").value;
    try {
      const res = await post("/.netlify/functions/house-wsw", { cycleId, topic, phase });
      cycleId = res.cycleId || cycleId;
      $("cx-out").textContent = JSON.stringify(res, null, 2);
      $("cx-status").textContent = "WSW ✓";
    } catch (e) {
      $("cx-status").textContent = "WSW error";
      $("cx-out").textContent = String(e);
    }
  };

  $("cx-run-wnw").onclick = async () => {
    if (!cycleId) { $("cx-out").textContent = "Start with WSW to create a cycleId."; return; }
    $("cx-status").textContent = "WNW…";
    try {
      const res = await post("/.netlify/functions/house-wnw", { cycleId });
      $("cx-out").textContent = JSON.stringify(res, null, 2);
      $("cx-status").textContent = "WNW ✓";
    } catch (e) {
      $("cx-status").textContent = "WNW error";
      $("cx-out").textContent = String(e);
    }
  };

  $("cx-run-core").onclick = async () => {
    if (!cycleId) { $("cx-out").textContent = "Run WSW (and optionally WNW) first."; return; }
    $("cx-status").textContent = "Core…";
    try {
      const res = await post("/.netlify/functions/core-gateway", { cycleId });
      $("cx-out").textContent = JSON.stringify(res, null, 2);
      $("cx-status").textContent = "Core ✓";
    } catch (e) {
      $("cx-status").textContent = "Core error";
      $("cx-out").textContent = String(e);
    }
  };
})();
</script>
<!-- ===== end Cycles MVP add-on ===== -->
</html>
